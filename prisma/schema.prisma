// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// User model for profile management (Clerk handles authentication)
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userProfile     UserProfile?
  userPreferences UserPreferences?
  interactions    UserInteraction[]
  preferences     UserPreference[]
  savedRepos      SavedRepository[]
  aiAnalyses      AiAnalysis[]
  repositoryAnalyses RepositoryAnalysis[]

  @@map("users")
}

// User profile for storing preferences and learning data
model UserProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  skillLevel       String   @default("beginner") // beginner, intermediate, advanced
  interests        String[] // Array of interest tags
  goals            String[] // Array of goal tags
  experience       Json?   // JSON field for complex experience data
  learnedWeights   Json?   // JSON field for ML weights
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// User preferences for onboarding
model UserPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  techStack       String[] // Array of tech stack preferences
  goal            String   @default("learn")
  experienceLevel String   @default("beginner")
  completed       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_onboarding_preferences")
}

// GitHub repository data
model Repository {
  id                String   @id @default(cuid())
  fullName          String   @unique
  name              String
  owner             String
  description       String?
  language          String?
  stars             Int      @default(0)
  forks             Int      @default(0)
  issues            Int      @default(0)
  contributors      Int      @default(0)
  lastUpdated       DateTime?
  topics            String[]
  techStack         String[]
  difficulty        String   @default("beginner") // beginner, intermediate, advanced, expert
  competition       String   @default("low") // low, medium, high
  hasContributing   Boolean  @default(false)
  matchScore        Float?  // AI-calculated match score
  aiAnalysis        Json?   // JSON field for AI analysis data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  interactions UserInteraction[]
  savedRepos   SavedRepository[]
  aiAnalyses   AiAnalysis[]

  @@map("repositories")
}

// User interactions with repositories
model UserInteraction {
  id                   String   @id @default(cuid())
  userId               String
  repositoryFullName   String
  type                 String   // view, like, contribute, analyze, bookmark
  score                Int?     // 1-5 rating
  metadata             Json?    // Additional interaction data
  timestamp            DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryFullName], references: [fullName], onDelete: Cascade)

  @@map("user_interactions")
}

// User preferences for recommendations (ML-based)
model UserPreference {
  id          String   @id @default(cuid())
  userId      String
  category    String   // e.g., "languages", "topics", "difficulty"
  key         String   // e.g., "javascript", "ai-ml", "advanced"
  value       Float    // Preference weight (0.0 - 1.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, key])
  @@map("user_ml_preferences")
}

// Saved repositories by users
model SavedRepository {
  id           String   @id @default(cuid())
  userId       String
  repoFullName String
  repoName     String
  repoUrl      String
  description  String?
  language     String?
  stars        Int      @default(0)
  tags         String[] // Repository topics/tags
  notes        String?
  savedAt      DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository Repository? @relation(fields: [repoFullName], references: [fullName], onDelete: Cascade)

  @@unique([userId, repoFullName])
  @@map("saved_repositories")
}

// AI analysis results
model AiAnalysis {
  id                String   @id @default(cuid())
  userId            String?
  repositoryFullName String
  analysisType      String   // "explanation", "flowchart", "component_explorer"
  content           Json     // AI-generated content
  metadata          Json?    // Analysis metadata
  createdAt         DateTime @default(now())
  expiresAt         DateTime?

  // Relations
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  repository Repository @relation(fields: [repositoryFullName], references: [fullName], onDelete: Cascade)

  @@map("ai_analyses")
}

// Repository analysis results
model RepositoryAnalysis {
  id                String   @id @default(cuid())
  userId            String
  repoFullName      String
  repoUrl           String
  flowchartMermaid  String   @db.Text
  explanation       Json     // Structured explanation data
  resources         Json     // Learning resources
  insights          Json?    // Architecture insights
  analysisVersion   String   @default("1.0")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, repoFullName])
  @@map("repository_analyses")
}

// Community statistics
model CommunityStats {
  id                     String   @id @default(cuid())
  totalQueries           Int      @default(0)
  totalUsers             Int      @default(0)
  activeRepositories     Int      @default(0)
  successfulContributions Int     @default(0)
  averageSatisfaction    Float    @default(0.0)
  date                   DateTime @default(now())
  createdAt              DateTime @default(now())

  @@map("community_stats")
}

// Popular repositories cache
model PopularRepository {
  id                String   @id @default(cuid())
  fullName          String   @unique
  name              String
  description       String?
  language          String?
  stars             Int      @default(0)
  forks             Int      @default(0)
  openIssues        Int      @default(0)
  topics            String[]
  competitionLevel  String   @default("moderate")
  activityLevel     String   @default("moderate")
  aiDomain          String   @default("other")
  difficultyLevel   String   @default("intermediate")
  difficultyScore   Float    @default(50.0)
  contributorCount  Int      @default(0)
  recentCommits     Int      @default(0)
  issueResponseRate Float    @default(50.0)
  documentationScore Float   @default(50.0)
  lastFetched       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("popular_repositories")
}

// Recommendation cache for performance
model RecommendationCache {
  id          String   @id @default(cuid())
  userId      String?
  cacheKey    String   @unique
  repositories Json     // Cached repository data
  metadata    Json?    // Cache metadata
  createdAt   DateTime @default(now())
  expiresAt   DateTime

  @@map("recommendation_cache")
}

// System configuration
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}
